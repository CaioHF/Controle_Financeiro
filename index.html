<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Finanças</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2488/2488749.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E3A8A">

    <style>
        /* ==================== ESTILOS GERAIS ==================== */
        :root {
            --primary: #1E3A8A; --success: #16A34A; --danger: #DC2626; --warning: #F59E0B;
            --background: #F8FAFC; --card: #FFFFFF; --nav-bg: #FFFFFF;
            --text-primary: #0F172A; --text-secondary: #64748B;
            --border: #E2E8F0; --secondary: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sidebar-width: 260px;
        }

        [data-theme="dark"] {
            --primary: #3B82F6; --success: #22C55E; --danger: #EF4444; --warning: #FBBF24;
            --background: #020617; --card: #0F172A; --nav-bg: #0F172A;
            --text-primary: #F8FAFC; --text-secondary: #94A3B8; --border: #1E293B; --secondary: #1E293B;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--background); color: var(--text-primary); min-height: 100vh; padding-bottom: 90px; padding-top: 70px; transition: 0.3s; }
        main { padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* HEADER */
        header.mobile-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--nav-bg); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 1000; box-shadow: var(--shadow); }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-left img { width: 24px; }
        .header-left h2 { font-size: 14px; margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 800; }
        .header-month-select { background-color: var(--background); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 30px 8px 15px; font-size: 15px; font-weight: 700; outline: none; max-width: 150px; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px; }
        .btn-gear { font-size: 20px; color: var(--text-secondary); cursor: pointer; padding: 5px; }

        /* GERAIS */
        .meses-container { display: none; }
        .desktop-sidebar { display: none; }
        .resumo-cards { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; width: 100%; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border); cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; }
        .ganho::before { background: var(--success); } .despesa::before { background: var(--danger); } .saldo-positivo::before { background: var(--primary); } .saldo-negativo::before { background: var(--danger); }
        .card h3 { color: var(--text-secondary); font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        .card p { font-size: 28px; font-weight: 800; color: var(--text-primary); }
        .ganho p { color: var(--success); } .despesa p { color: var(--danger); } .saldo-positivo p { color: var(--primary); } .saldo-negativo p { color: var(--danger); }

        /* FORMULÁRIOS & MODAIS */
        .form-container { background: var(--card); padding: 20px; border-radius: 16px; border: none; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; outline: none; font-size: 16px; background-color: var(--background); color: var(--text-primary); transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }
        
        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: var(--primary); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; transition: transform 0.2s; border: none; }
        .fab:active { transform: scale(0.9); }
        .fab.show { display: flex; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        button.btn-sucesso { background-color: var(--primary); color: #fff; border: none; padding: 14px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        button.btn-sucesso:active { transform: scale(0.98); }
        
        button.btn-importar { background-color: transparent; color: var(--primary); border: 2px dashed var(--primary); padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 20px; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; cursor: pointer; }
        button.btn-importar:hover { background-color: var(--background); opacity: 0.8; }
        
        .filter-container { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background-color: var(--background); color: var(--text-secondary); border: 1px solid var(--border); padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        
        .lista-contas { list-style: none; } 
        .item-conta { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .check-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: transparent; transition: 0.2s; flex-shrink: 0; background: transparent; }
        .check-circle.checked { background-color: var(--success); border-color: var(--success); color: white; font-size: 12px; }

        .conta-content { flex: 1; overflow: hidden; }
        .conta-info strong { display: block; font-size: 15px; color: var(--text-primary); } 
        .conta-info small { font-size: 12px; color: var(--text-secondary); }
        .valor-e-menu { display: flex; align-items: center; gap: 10px; }

        .riscado { opacity: 0.5; } .riscado strong { text-decoration: line-through; }
        
        .detalhe-motivo { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); font-size: 13px; color: var(--text-secondary); font-style: italic; animation: fadeIn 0.3s; }
        .detalhe-visivel { display: block; }

        .emp-parcelas { display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 12px; color: var(--text-secondary); width: 100%; }
        .emp-barra-bg { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .emp-barra-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-in-out; }
        .btn-receber-parc { background: var(--background); border: 1px solid var(--success); color: var(--success); border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: bold; cursor: pointer; margin-right: 5px; min-width: 80px; text-align: center; transition: 0.2s; }
        .btn-receber-parc:active { background: var(--success); color: #fff; transform: scale(0.95); }

        .badge-venc { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .badge-red { background-color: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .badge-yellow { background-color: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
        .badge-green { background-color: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; }
        
        .btn-more { background: none; border: none; font-size: 18px; color: var(--text-secondary); padding: 5px; cursor: pointer; }
        .dropdown-menu { display: none; position: absolute; right: 40px; bottom: 100%; background-color: var(--card); min-width: 140px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 99; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 5px; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu button { width: 100%; padding: 12px; text-align: left; background: none; border: none; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-primary); transition: 0.2s; cursor: pointer; }
        .dropdown-menu button:hover { background-color: var(--background); }
        .opt-del { color: var(--danger) !important; }
        .opt-del.confirmando { background-color: transparent !important; color: var(--danger) !important; font-weight: 800; text-transform: uppercase; }
        
        .meta-card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; box-shadow: var(--shadow); }
        .meta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .meta-header h3 { margin: 0; font-size: 16px; color: var(--text-primary); }
        .meta-percent { font-size: 14px; font-weight: bold; color: var(--primary); }
        .barra-container { height: 12px; background-color: var(--background); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 8px; }
        .barra-fill { height: 100%; background-color: var(--primary); border-radius: 6px; transition: width 0.5s; }
        .barra-completa { background-color: var(--success); }
        .meta-values { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); }
        .btn-depositar { background-color: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 10px; width: 100%; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-depositar:hover { background-color: var(--primary); color: #fff; }
        .btn-excluir-meta { color: var(--text-secondary); background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; transition: 0.2s; }
        .meta-delete-active { color: var(--danger) !important; transform: scale(1.1); font-weight: bold; }
        
        .tela { display: none; animation: fadeIn 0.3s; } .tela-ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: flex-end; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--card); padding: 30px 25px; border-radius: 25px 25px 0 0; width: 100%; max-width: 600px; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; color: var(--text-primary); position: relative; }
        .close-modal-fixed { position: absolute; top: 15px; right: 20px; font-size: 28px; color: var(--text-secondary); cursor: pointer; z-index: 10; padding: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; margin-bottom: 30px; }
        .menu-option { background-color: var(--background); padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; font-weight: 500; }
        .menu-option i { font-size: 26px; color: var(--primary); }
        .config-section button { margin-bottom: 10px; width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--background); color: var(--text-primary); text-align: left; display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .calc-display { background: var(--background); padding: 20px; font-size: 28px; text-align: right; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border); font-family: monospace; font-weight: bold; color: var(--text-primary); overflow: hidden; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-grid button { padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); font-size: 20px; cursor: pointer; color: var(--text-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .calc-grid button:active { transform: scale(0.95); background: var(--background); }
        .btn-op { background-color: var(--warning) !important; color: white !important; border: none !important; }
        .btn-eq { background-color: var(--success) !important; color: white !important; border: none !important; }
        .btn-clr { background-color: var(--danger) !important; color: white !important; border: none !important; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%); bottom: 90px; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background-color: var(--nav-bg); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 10px; cursor: pointer; width: 20%; transition: 0.2s; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.active i { transform: translateY(-2px); }
        .relatorio-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .install-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .btn-install { padding: 15px; border-radius: 12px; border: none; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        @media (min-width: 1024px) {
            body { padding: 0; padding-left: var(--sidebar-width); padding-top: 0; }
            .bottom-nav, header.mobile-header, .menu-grid, .mobile-month-selector { display: none !important; }
            .desktop-sidebar { display: flex; flex-direction: column; width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; background-color: var(--nav-bg); border-right: 1px solid var(--border); z-index: 100; padding: 20px; }
            .sidebar-logo { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 40px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
            .sidebar-menu { list-style: none; flex-grow: 1; }
            .sidebar-item { padding: 15px 20px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 15px; font-size: 15px; transition: 0.2s; }
            .sidebar-item:hover { background-color: var(--background); color: var(--primary); }
            .sidebar-item.active { background-color: var(--primary); color: #fff; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
            main { padding: 40px; max-width: 1200px; }
            .meses-container { display: flex; position: sticky; top: 0; padding: 20px 0; background-color: var(--background); z-index: 90; box-shadow: none; border: none; width: auto; left: auto; }
            .resumo-cards { flex-direction: row; }
            .form-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end; }
            .form-container .input-group { margin-bottom: 0; }
            .form-container h4 { grid-column: 1 / -1; margin-bottom: 10px; }
            .form-container button { height: 48px; }
            .form-full-width { grid-column: 1 / -1; }
            .modal { align-items: center; }
            .modal-content { border-radius: 20px; max-width: 500px; animation: fadeIn 0.3s; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        }
    </style>
</head>
<body>

    <div id="toast">Salvo com sucesso!</div>

    <button id="btn-fab-add" class="fab" onclick="abrirModalContexto()"><i class="fa-solid fa-plus"></i></button>

    <header class="mobile-header">
        <div class="header-left">
            <img src="https://cdn-icons-png.flaticon.com/512/2488/2488749.png" alt="Logo">
            <h2>Minhas Finanças</h2>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="select-meses" class="header-month-select" onchange="selecionarMes(this.value)"></select>
            <i class="fa-solid fa-gear btn-gear" onclick="abrirConfiguracoes()"></i>
        </div>
    </header>

    <aside class="desktop-sidebar">
        <div class="sidebar-logo"><i class="fa-solid fa-wallet"></i> Minhas Finanças</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" onclick="navegar('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Visão Geral</li>
            <li class="sidebar-item" onclick="navegar('receitas', this)"><i class="fa-solid fa-sack-dollar"></i> Receitas</li>
            <li class="sidebar-item" onclick="navegar('contas', this)"><i class="fa-solid fa-file-invoice-dollar"></i> Contas Fixas</li>
            <li class="sidebar-item" onclick="navegar('gastos', this)"><i class="fa-solid fa-cart-shopping"></i> Gastos Diários</li>
            <li class="sidebar-item" onclick="navegar('metas', this)"><i class="fa-solid fa-bullseye"></i> Metas</li>
            <li class="sidebar-item" onclick="navegar('emprestados', this)"><i class="fa-solid fa-hand-holding-dollar"></i> Empréstimos</li>
        </ul>
        <div style="margin-top: auto;">
            <li class="sidebar-item" onclick="abrirConfiguracoes()"><i class="fa-solid fa-gear"></i> Configurações</li>
        </div>
    </aside>

    <main>
        <div class="meses-container" id="barra-meses"></div>

        <section id="tela-dashboard" class="tela tela-ativa">
            <div class="resumo-cards">
                <div class="card ganho" onclick="abrirRelatorio('entrada')">
                    <h3>Entradas <i class="fa-solid fa-circle-info" style="font-size:12px; margin-left:5px;"></i></h3><p id="dash-receita">R$ 0,00</p>
                </div>
                <div class="card despesa" onclick="abrirRelatorio('saida')">
                    <h3>Saídas <i class="fa-solid fa-circle-info" style="font-size:12px; margin-left:5px;"></i></h3><p id="dash-gastos">R$ 0,00</p>
                </div>
                <div class="card saldo-positivo" id="card-saldo">
                    <h3>Saldo</h3><p id="dash-saldo">R$ 0,00</p>
                </div>
            </div>
        </section>

        <section id="tela-receitas" class="tela">
            <h1 style="margin-bottom:20px;">Receitas</h1>
            <ul id="lista-visual-extras" class="lista-contas"></ul>
        </section>

        <section id="tela-contas" class="tela">
            <h1>Contas Fixas</h1>
            <div class="filter-container">
                <button class="filter-btn active" onclick="filtrarContas('todos', this)">Todas</button>
                <button class="filter-btn" onclick="filtrarContas('pendentes', this)">Pendentes</button>
                <button class="filter-btn" onclick="filtrarContas('pagos', this)">Pagas</button>
            </div>
            <button id="btn-importar" class="btn-importar" onclick="importarContasMesAnterior()" style="display:none;"><i class="fa-solid fa-copy"></i> Copiar do mês passado</button>
            <ul id="lista-visual-contas" class="lista-contas"></ul>
        </section>

        <section id="tela-gastos" class="tela">
            <h1>Gastos Diários</h1>
            <ul id="lista-visual-gastos" class="lista-contas" style="margin-top:20px;"></ul>
        </section>

        <section id="tela-metas" class="tela">
            <h1>Metas</h1>
            <div id="lista-visual-metas" style="margin-top:20px;"></div>
        </section>

        <section id="tela-emprestados" class="tela">
            <h1>Empréstimos</h1>
            <ul id="lista-visual-emprestimos" class="lista-contas" style="margin-top:20px;"></ul>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navegar('dashboard', this)"><i class="fa-solid fa-chart-pie"></i>Dash</div>
        <div class="nav-item" onclick="navegar('receitas', this)"><i class="fa-solid fa-sack-dollar"></i>Receitas</div>
        <div class="nav-item" onclick="navegar('contas', this)"><i class="fa-solid fa-file-invoice-dollar"></i>Contas</div>
        <div class="nav-item" onclick="navegar('gastos', this)"><i class="fa-solid fa-cart-shopping"></i>Gastos</div>
        <div class="nav-item" onclick="abrirMenuFunc()"><i class="fa-solid fa-bars"></i>Menu</div>
    </nav>

    <div id="modal-func" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-func')">&times;</span>
            <h3 style="margin-bottom:20px; text-align:center;">Menu</h3>
            <div class="menu-grid"> 
                <div class="menu-option" onclick="navegar('metas'); fecharModalId('modal-func')"><i class="fa-solid fa-bullseye"></i> Metas</div>
                <div class="menu-option" onclick="navegar('emprestados'); fecharModalId('modal-func')"><i class="fa-solid fa-hand-holding-dollar"></i> Empréstimos</div>
                <div class="menu-option" onclick="abrirCalculadora()"><i class="fa-solid fa-calculator"></i> Calculadora</div>
                <div class="menu-option" onclick="abrirRelatorioDRE()"><i class="fa-solid fa-file-invoice"></i> Relatórios</div>
            </div>
        </div>
    </div>

    <div id="modal-form-extra" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-form-extra')">&times;</span>
            <h3>Nova Receita</h3>
            <div class="form-container">
                <div class="input-group"><label>Descrição (Ex: Salário, Venda)</label><input type="text" id="extra-desc"></div>
                <div class="input-group"><label>Valor</label><input type="number" id="extra-valor"></div>
                <button class="btn-sucesso" onclick="adicionarGanhoExtra()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-form-conta" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-form-conta')">&times;</span>
            <h3>Conta Fixa</h3>
            <div class="form-container">
                <div class="input-group"><label>Nome da Conta</label><input type="text" id="nome-conta"></div>
                <div class="input-group"><label>Valor</label><input type="number" id="valor-conta"></div>
                <div class="input-group"><label>Vencimento</label><input type="date" id="vencimento-conta"></div>
                <button id="btn-salvar-conta" class="btn-sucesso" onclick="adicionarConta()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-form-gasto" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-form-gasto')">&times;</span>
            <h3>Gasto Diário</h3>
            <div class="form-container">
                <div class="input-group"><label>Descrição</label><input type="text" id="gasto-nome"></div>
                <div class="input-group"><label>Valor</label><input type="number" id="gasto-valor"></div>
                <div class="input-group"><label>Data</label><input type="date" id="gasto-data"></div>
                <button class="btn-sucesso" onclick="adicionarGastoDiario()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-form-meta" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-form-meta')">&times;</span>
            <h3>Nova Meta</h3>
            <div class="form-container">
                <div class="input-group"><label>Objetivo</label><input type="text" id="meta-nome"></div>
                <div class="input-group"><label>Valor Total</label><input type="number" id="meta-valor"></div>
                <button class="btn-sucesso" onclick="adicionarMeta()">Criar Meta</button>
            </div>
        </div>
    </div>

    <div id="modal-form-emp" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-form-emp')">&times;</span>
            <h3>Empréstimo</h3>
            <div class="form-container">
                <div class="input-group"><label>Para quem?</label><input type="text" id="emp-nome"></div>
                <div class="input-group"><label>Motivo</label><input type="text" id="emp-desc" placeholder="Ex: Compra Havan"></div>
                <div class="input-group"><label>Valor da Parcela</label><input type="number" id="emp-valor"></div>
                <div class="input-group"><label>Nº Parcelas</label><input type="number" id="emp-parcelas" value="1"></div>
                <div class="input-group"><label>Data Início</label><input type="date" id="emp-data"></div>
                <button id="btn-salvar-emp" class="btn-sucesso" onclick="salvarEmprestimo()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-config" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-config')">&times;</span>
            <h3 style="margin-bottom:20px; text-align:center;">Configurações</h3>
            <div class="config-section">
                <button class="btn-config" onclick="toggleDarkMode()"><i id="icon-theme" class="fa-solid fa-moon"></i> Alternar Tema</button>
                <button class="btn-config" onclick="baixarBackup()"><i class="fa-solid fa-download"></i> Salvar Backup</button>
                <button class="btn-config" onclick="document.getElementById('input-restore').click()"><i class="fa-solid fa-upload"></i> Restaurar Backup</button>
                <input type="file" id="input-restore" style="display:none;" onchange="restaurarBackup(this)">
                <button class="btn-config" onclick="abrirModalId('modal-install')"><i class="fa-solid fa-mobile-screen"></i> Baixar Aplicativo</button>
            </div>
        </div>
    </div>

    <div id="modal-calculadora" class="modal" onclick="fecharModal(event, 'modal-calculadora')">
        <div class="modal-content" style="max-width: 350px;">
            <span class="close-modal-fixed" onclick="document.getElementById('modal-calculadora').style.display='none'">&times;</span>
            <h3 style="margin-bottom:15px;">Calculadora</h3>
            <div class="calc-display" id="calc-display">0</div>
            <div class="calc-grid">
                <button onclick="clearCalc()" class="btn-clr" style="grid-column: span 3;">C</button>
                <button onclick="addCalc('/')" class="btn-op">÷</button>
                <button onclick="addCalc('7')">7</button><button onclick="addCalc('8')">8</button><button onclick="addCalc('9')">9</button><button onclick="addCalc('*')" class="btn-op">×</button>
                <button onclick="addCalc('4')">4</button><button onclick="addCalc('5')">5</button><button onclick="addCalc('6')">6</button><button onclick="addCalc('-')" class="btn-op">-</button>
                <button onclick="addCalc('1')">1</button><button onclick="addCalc('2')">2</button><button onclick="addCalc('3')">3</button><button onclick="addCalc('+')" class="btn-op">+</button>
                <button onclick="addCalc('0')" style="grid-column: span 2;">0</button><button onclick="addCalc('.')">.</button><button onclick="resultCalc()" class="btn-eq">=</button>
            </div>
        </div>
    </div>

    <div id="modal-install" class="modal">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="fecharModalId('modal-install')">&times;</span>
            <h3>Baixar App</h3>
            <div class="install-options">
                <button class="btn-install" style="background:var(--success)" onclick="tentarInstallAndroid()"><i class="fa-brands fa-android" style="font-size:30px"></i>Android</button>
                <button class="btn-install" style="background:var(--primary)" onclick="mostrarHelpIOS()"><i class="fa-brands fa-apple" style="font-size:30px"></i>iPhone</button>
            </div>
            <div id="ios-help" style="display:none; margin-top:20px; background:var(--background); padding:15px; border-radius:10px; border:1px solid var(--border);">
                <p style="margin-bottom:5px">1. Abra no <strong>Safari</strong>.</p>
                <p style="margin-bottom:5px">2. Toque em <strong>Compartilhar</strong> <i class="fa-solid fa-arrow-up-from-bracket" style="color:var(--primary)"></i>.</p>
                <p>3. Escolha <strong>"Adicionar à Tela de Início"</strong>.</p>
            </div>
            <div id="android-help" style="display:none; margin-top:20px; background:var(--background); padding:15px; border-radius:10px; border:1px solid var(--success);">
                <p>Toque nos <strong>3 pontinhos</strong> do navegador e escolha <strong>"Instalar aplicativo"</strong>.</p>
            </div>
        </div>
    </div>

    <div id="modal-lista" class="modal" onclick="fecharModal(event, 'modal-lista')">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="document.getElementById('modal-lista').style.display='none'">&times;</span>
            <h3 id="titulo-lista" style="margin-bottom:15px; text-align:center;">Detalhes</h3>
            <ul id="conteudo-lista" style="list-style:none;"></ul>
        </div>
    </div>

    <div id="modal-dre" class="modal" onclick="fecharModal(event, 'modal-dre')">
        <div class="modal-content">
            <span class="close-modal-fixed" onclick="document.getElementById('modal-dre').style.display='none'">&times;</span>
            <h3 style="text-align:center;">Relatório DRE</h3>
            <div id="conteudo-dre" style="margin-top:20px; font-size:14px; line-height:1.6;"></div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const mesesNomes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const anoFixo = 2026;
        
        let mesSelecionado = localStorage.getItem('financas_ultimo_mes') || `${anoFixo}-01`;
        let filtroContas = 'todos';
        let telaAtual = 'dashboard';
        let idEdit = null;

        // --- DADOS (V10 para Limpeza) ---
        let db = JSON.parse(localStorage.getItem('financas_db_v10')) || { 
            extras: [], contas: [], gastos: [], emprestimos: [], metas: [] 
        };
        
        // Safety Check
        if (!db.extras) db.extras = [];
        if (!db.contas) db.contas = [];
        if (!db.gastos) db.gastos = [];
        if (!db.emprestimos) db.emprestimos = [];
        if (!db.metas) db.metas = [];

        function saveDB() { localStorage.setItem('financas_db_v10', JSON.stringify(db)); }
        function showToast(msg) { 
            const t = document.getElementById('toast'); t.innerHTML = msg; t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        function init() {
            gerarMeses();
            selecionarMes(mesSelecionado);
            atualizarFab();
            if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
        }

        // --- SISTEMA DE MESES ---
        function gerarMeses() {
            const el = document.getElementById('select-meses'); el.innerHTML = "";
            const desk = document.getElementById('barra-meses'); if(desk) desk.innerHTML = "";
            
            for(let i=0; i<12; i++) {
                let m = String(i+1).padStart(2,'0');
                let k = `${anoFixo}-${m}`;
                let nome = mesesNomes[i];
                
                // Mobile
                let opt = document.createElement('option');
                opt.value = k; opt.innerText = `${nome}/${anoFixo.toString().slice(2)}`;
                if(k === mesSelecionado) opt.selected = true;
                el.appendChild(opt);

                // Desktop
                if(desk) {
                    let div = document.createElement('div');
                    div.className = `mes-pill ${k===mesSelecionado?'mes-ativo':''}`;
                    div.innerText = nome;
                    div.onclick = () => selecionarMes(k);
                    desk.appendChild(div);
                }
            }
        }

        function selecionarMes(k) {
            mesSelecionado = k;
            localStorage.setItem('financas_ultimo_mes', k);
            gerarMeses(); 
            atualizarUI();
        }

        // --- NAVEGAÇÃO ---
        function navegar(tela, el) {
            telaAtual = tela;
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('tela-ativa'));
            document.getElementById(`tela-${tela}`).classList.add('tela-ativa');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el && el.classList.contains('nav-item')) el.classList.add('active');
            
            // Fecha menu se aberto
            fecharModalId('modal-func');
            atualizarFab();
        }

        function atualizarFab() {
            const fab = document.getElementById('btn-fab-add');
            if(telaAtual === 'dashboard') {
                fab.style.display = 'none';
            } else {
                fab.style.display = 'flex';
                setTimeout(()=> fab.classList.add('show'), 50);
            }
        }

        // --- MODAIS ---
        function abrirModalContexto() {
            idEdit = null; 
            limparInputs();
            if(telaAtual === 'receitas') abrirModalId('modal-form-extra');
            if(telaAtual === 'contas') { 
                document.getElementById('btn-salvar-conta').innerText="Salvar"; 
                abrirModalId('modal-form-conta'); 
            }
            if(telaAtual === 'gastos') abrirModalId('modal-form-gasto');
            if(telaAtual === 'metas') abrirModalId('modal-form-meta');
            if(telaAtual === 'emprestados') {
                document.getElementById('btn-salvar-emp').innerText="Salvar";
                abrirModalId('modal-form-emp');
            }
        }

        function abrirModalId(id) { document.getElementById(id).style.display = 'flex'; }
        function fecharModalId(id) { document.getElementById(id).style.display = 'none'; }
        function abrirMenuFunc() { abrirModalId('modal-func'); }
        function abrirConfiguracoes() { abrirModalId('modal-config'); }

        function limparInputs() {
            document.querySelectorAll('.modal input').forEach(i => i.value = "");
            document.querySelectorAll('.modal input[type="date"]').forEach(d => d.value = `${mesSelecionado}-05`); 
        }

        // --- CRUD LÓGICA ---
        function adicionarGanhoExtra() {
            const desc = document.getElementById('extra-desc').value;
            const val = parseFloat(document.getElementById('extra-valor').value);
            if(!desc || isNaN(val)) return;
            
            db.extras.unshift({ id: Date.now(), desc, valor: val, mesRef: mesSelecionado });
            saveDB(); atualizarUI(); fecharModalId('modal-form-extra'); showToast("Salvo!");
        }

        function adicionarConta() {
            const nome = document.getElementById('nome-conta').value;
            const val = parseFloat(document.getElementById('valor-conta').value);
            const venc = document.getElementById('vencimento-conta').value;
            if(!nome || isNaN(val)) return;

            if(idEdit) {
                const item = db.contas.find(x => x.id === idEdit);
                if(item) { item.nome = nome; item.valor = val; item.vencimento = venc; }
            } else {
                db.contas.push({ id: Date.now(), nome, valor: val, vencimento: venc, pago: false, mesRef: mesSelecionado });
            }
            saveDB(); atualizarUI(); verificarBotaoImportar(); fecharModalId('modal-form-conta'); showToast("Salvo!");
        }

        function adicionarGastoDiario() {
            const nome = document.getElementById('gasto-nome').value;
            const val = parseFloat(document.getElementById('gasto-valor').value);
            const data = document.getElementById('gasto-data').value;
            if(!nome || isNaN(val)) return;

            db.gastos.unshift({ id: Date.now(), nome, valor: val, data, mesRef: mesSelecionado });
            saveDB(); atualizarUI(); fecharModalId('modal-form-gasto'); showToast("Salvo!");
        }

        function adicionarMeta() {
            const nome = document.getElementById('meta-nome').value;
            const val = parseFloat(document.getElementById('meta-valor').value);
            if(!nome || isNaN(val)) return;

            db.metas.push({ id: Date.now(), nome, total: val, guardado: 0 });
            saveDB(); atualizarUI(); fecharModalId('modal-form-meta'); showToast("Salvo!");
        }

        function salvarEmprestimo() {
            const nome = document.getElementById('emp-nome').value;
            const desc = document.getElementById('emp-desc').value;
            const val = parseFloat(document.getElementById('emp-valor').value);
            const parc = parseInt(document.getElementById('emp-parcelas').value) || 1;
            const data = document.getElementById('emp-data').value;
            if(!nome || isNaN(val)) return;

            if(idEdit) {
                const item = db.emprestimos.find(x => x.id === idEdit);
                if(item) { item.nome = nome; item.desc = desc; item.valor = val; item.parcelas = parc; item.data = data; }
            } else {
                db.emprestimos.push({ id: Date.now(), nome, desc, valor: val, parcelas: parc, pagas: 0, data, recebido: false });
            }
            saveDB(); atualizarUI(); fecharModalId('modal-form-emp'); showToast("Salvo!");
        }

        // --- AÇÕES ---
        function toggleConta(id) {
            const c = db.contas.find(x => x.id === id);
            if(c) { c.pago = !c.pago; saveDB(); atualizarUI(); }
        }

        function pagarParcela(id) {
            const e = db.emprestimos.find(x => x.id === id);
            if(e) {
                e.pagas++;
                if(e.pagas >= e.parcelas) { e.pagas = e.parcelas; e.recebido = true; }
                saveDB(); atualizarUI(); showToast(`Recebido! (${e.pagas}/${e.parcelas})`);
            }
        }

        function depositarMeta(id) {
            const v = parseFloat(prompt("Valor para guardar:"));
            if(!isNaN(v)) {
                const m = db.metas.find(x => x.id === id);
                if(m) { m.guardado += v; saveDB(); atualizarUI(); }
            }
        }

        function excluirItem(tipo, id, btn, event) {
            if(event) event.stopPropagation();
            if(btn.classList.contains('confirmando')) {
                if(tipo === 'conta') db.contas = db.contas.filter(x => x.id !== id);
                if(tipo === 'gasto') db.gastos = db.gastos.filter(x => x.id !== id);
                if(tipo === 'extra') db.extras = db.extras.filter(x => x.id !== id);
                if(tipo === 'meta') db.metas = db.metas.filter(x => x.id !== id);
                if(tipo === 'emp') db.emprestimos = db.emprestimos.filter(x => x.id !== id);
                saveDB(); atualizarUI(); showToast("Excluído!");
            } else {
                btn.classList.add('confirmando');
                const orig = btn.innerText;
                btn.innerText = "Confirmar?";
                setTimeout(() => { 
                    if(btn) { 
                        btn.classList.remove('confirmando'); 
                        btn.innerText = "Excluir"; 
                    } 
                }, 3000);
            }
        }

        function editarItem(tipo, id) {
            idEdit = id;
            if(tipo === 'conta') {
                const i = db.contas.find(x => x.id === id);
                document.getElementById('nome-conta').value = i.nome;
                document.getElementById('valor-conta').value = i.valor;
                document.getElementById('vencimento-conta').value = i.vencimento;
                document.getElementById('btn-salvar-conta').innerText = "Atualizar";
                abrirModalId('modal-form-conta');
            }
            if(tipo === 'emp') {
                const i = db.emprestimos.find(x => x.id === id);
                document.getElementById('emp-nome').value = i.nome;
                document.getElementById('emp-desc').value = i.desc;
                document.getElementById('emp-valor').value = i.valor;
                document.getElementById('emp-parcelas').value = i.parcelas;
                document.getElementById('emp-data').value = i.data;
                document.getElementById('btn-salvar-emp').innerText = "Atualizar";
                abrirModalId('modal-form-emp');
            }
        }

        function filtrarContas(tipo, btn) {
            filtroContas = tipo;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderContas();
        }

        // --- RENDERIZAÇÃO ---
        function atualizarUI() {
            renderDashboard();
            renderExtras();
            renderContas();
            renderGastos();
            renderMetas();
            renderEmprestimos();
        }

        function renderDashboard() {
            const extras = db.extras.filter(x => x.mesRef === mesSelecionado);
            const contas = db.contas.filter(x => x.mesRef === mesSelecionado);
            const gastos = db.gastos.filter(x => x.mesRef === mesSelecionado);
            
            // Receita: Apenas Extras + (Opcional: Parcelas Recebidas se quiser)
            // Aqui vamos somar tudo o que entrou "de fato"
            let totalRec = extras.reduce((a,b) => a + b.valor, 0);
            
            // Soma histórico de parcelas pagas
            db.emprestimos.forEach(e => { totalRec += (e.valor * e.pagas); }); 

            // Despesa: Contas (todas ou só pagas?) + Gastos
            let totalDesp = 0;
            contas.forEach(c => { 
                // Se quiser somar só as pagas: if(c.pago) ...
                // Para previsão, somamos tudo:
                totalDesp += c.valor; 
            });
            gastos.forEach(g => totalDesp += g.valor);

            const saldo = totalRec - totalDesp;

            document.getElementById('dash-receita').innerText = totalRec.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('dash-gastos').innerText = totalDesp.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('dash-saldo').innerText = saldo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            
            // Cores do saldo
            const cardSaldo = document.getElementById('card-saldo');
            if(saldo < 0) {
                cardSaldo.className = "card saldo-negativo";
            } else {
                cardSaldo.className = "card saldo-positivo";
            }
        }

        function renderExtras() {
            const el = document.getElementById('lista-visual-extras'); el.innerHTML = "";
            const lista = db.extras.filter(x => x.mesRef === mesSelecionado);
            if(lista.length === 0) el.innerHTML = "<p style='text-align:center; color:#999; font-size:12px; margin-top:10px;'>Sem receitas.</p>";
            
            lista.forEach(i => {
                el.innerHTML += `
                <li class="item-conta">
                    <div class="conta-content"><strong>${i.desc}</strong></div>
                    <div class="valor-e-menu">
                        <strong style="color:var(--success)">R$ ${i.valor}</strong>
                        <button onclick="excluirItem('extra', ${i.id}, this, event)" class="opt-del" style="background:none; border:none; padding:5px;"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </li>`;
            });
        }

        function renderContas() {
            const el = document.getElementById('lista-visual-contas'); el.innerHTML = "";
            let lista = db.contas.filter(x => x.mesRef === mesSelecionado);
            
            if(filtroContas === 'pendentes') lista = lista.filter(x => !x.pago);
            if(filtroContas === 'pagos') lista = lista.filter(x => x.pago);

            if(lista.length === 0) {
                el.innerHTML = "<p style='text-align:center; color:#999; font-size:12px; margin-top:10px;'>Nenhuma conta.</p>";
                return;
            }

            lista.forEach(i => {
                const venc = i.vencimento ? new Date(i.vencimento).toLocaleDateString('pt-BR', {timeZone:'UTC'}) : '-';
                const statusClass = i.pago ? 'checked' : '';
                const riscoClass = i.pago ? 'riscado' : '';
                const checkIcon = i.pago ? '<i class="fa-solid fa-check"></i>' : '';
                
                // Alerta vencimento
                let alerta = "";
                if(!i.pago && i.vencimento) {
                    const hoje = new Date().toISOString().split('T')[0];
                    if(i.vencimento < hoje) alerta = `<span class="badge-venc badge-red">VENCIDA</span>`;
                    else if(i.vencimento === hoje) alerta = `<span class="badge-venc badge-yellow">HOJE</span>`;
                }

                el.innerHTML += `
                <li class="item-conta ${riscoClass}">
                    <div class="check-circle ${statusClass}" onclick="toggleConta(${i.id})">${checkIcon}</div>
                    <div class="conta-content">
                        <strong>${i.nome} ${alerta}</strong>
                        <small>Vence: ${venc}</small>
                    </div>
                    <div class="valor-e-menu">
                        <strong>R$ ${i.valor}</strong>
                        <div style="position:relative;">
                            <button class="btn-more" onclick="this.nextElementSibling.classList.toggle('show')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div class="dropdown-menu">
                                <button onclick="editarItem('conta', ${i.id})">Editar</button>
                                <button onclick="excluirItem('conta', ${i.id}, this, event)" class="opt-del">Excluir</button>
                            </div>
                        </div>
                    </div>
                </li>`;
            });
        }

        function renderGastos() {
            const el = document.getElementById('lista-visual-gastos'); el.innerHTML = "";
            const lista = db.gastos.filter(x => x.mesRef === mesSelecionado);
            if(lista.length === 0) el.innerHTML = "<p style='text-align:center; color:#999; font-size:12px; margin-top:10px;'>Sem gastos.</p>";

            lista.forEach(i => {
                const dia = new Date(i.data).toLocaleDateString('pt-BR', {timeZone:'UTC'});
                el.innerHTML += `
                <li class="item-conta">
                    <div class="conta-content"><strong>${i.nome}</strong><small>${dia}</small></div>
                    <div class="valor-e-menu">
                        <strong style="color:var(--danger)">R$ ${i.valor}</strong>
                        <button onclick="excluirItem('gasto', ${i.id}, this, event)" class="opt-del" style="background:none; border:none; padding:5px;"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </li>`;
            });
        }

        function renderMetas() {
            const el = document.getElementById('lista-visual-metas'); el.innerHTML = "";
            if(db.metas.length === 0) el.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Nenhuma meta ainda.</p>';
            
            db.metas.forEach(m => {
                let pct = (m.guardado / m.total) * 100;
                if(pct > 100) pct = 100;
                
                el.innerHTML += `
                <div class="meta-card">
                    <div class="meta-header">
                        <h3>${m.nome}</h3>
                        <button class="btn-excluir-meta" onclick="excluirItem('meta', ${m.id}, this, event)"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="meta-info-row">
                        <span style="font-size:12px; color:var(--text-secondary)">Progresso</span>
                        <div class="meta-percent">${Math.round(pct)}%</div>
                    </div>
                    <div class="barra-container">
                        <div class="barra-fill ${pct>=100?'barra-completa':''}" style="width:${pct}%"></div>
                    </div>
                    <div class="meta-values">
                        <span>R$ ${m.guardado}</span>
                        <span>Meta: R$ ${m.total}</span>
                    </div>
                    <button class="btn-depositar" onclick="depositarMeta(${m.id})"><i class="fa-solid fa-plus"></i> Guardar</button>
                </div>`;
            });
        }

        function renderEmprestimos() {
            const el = document.getElementById('lista-visual-emprestimos'); el.innerHTML = "";
            
            db.emprestimos.forEach(e => {
                const pct = (e.pagas / e.parcelas) * 100;
                const status = e.recebido ? `<span style="color:var(--success); font-weight:bold; font-size:12px;">Concluído</span>` : 
                                            `<button class="btn-receber-parc" onclick="pagarParcela(${e.id})">Receber</button>`;
                
                const toggleId = `det-${e.id}`;
                const detalheHtml = e.desc ? `<div id="${toggleId}" class="detalhe-motivo">📝 ${e.desc}</div>` : '';
                const clickAction = e.desc ? `onclick="document.getElementById('${toggleId}').classList.toggle('detalhe-visivel')"` : '';

                el.innerHTML += `
                <li class="item-conta">
                    <div class="conta-content" ${clickAction}>
                        <strong>${e.nome}</strong>
                        <div class="emp-meta-text" style="font-size:11px; color:#666; margin-top:4px;">
                            <span>${e.pagas}/${e.parcelas} pagas</span>
                        </div>
                        <div class="emp-barra-bg"><div class="emp-barra-fill" style="width:${pct}%"></div></div>
                        ${detalheHtml}
                    </div>
                    <div class="valor-e-menu">
                        ${status}
                        <div style="text-align:right;">
                            <strong style="color:var(--primary); display:block;">R$ ${e.valor}</strong>
                            <small style="font-size:10px;">/parc</small>
                        </div>
                        <div style="position:relative;">
                            <button class="btn-more" onclick="this.nextElementSibling.classList.toggle('show')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div class="dropdown-menu">
                                <button onclick="editarItem('emp', ${e.id})">Editar</button>
                                <button onclick="excluirItem('emp', ${e.id}, this, event)" class="opt-del">Excluir</button>
                            </div>
                        </div>
                    </div>
                </li>`;
            });
        }

        // --- RELATÓRIOS (CORRIGIDO) ---
        function abrirRelatorio(tipo) {
            const modal = document.getElementById('modal-lista');
            const lista = document.getElementById('conteudo-lista');
            const titulo = document.getElementById('titulo-lista');
            const fmt = { style: 'currency', currency: 'BRL' };
            lista.innerHTML = ""; 
            
            let itens = [];

            if (tipo === 'entrada') {
                titulo.innerText = "Entradas Detalhadas"; titulo.style.color = "var(--success)";
                db.extras.filter(i => i.mesRef === mesSelecionado).forEach(e => itens.push({n: e.desc, v: e.valor}));
                db.emprestimos.forEach(e => {
                    const recebido = (e.valor * (e.pagas || 0));
                    if(recebido > 0) itens.push({n: `Emp: ${e.nome}`, v: recebido});
                });
            } else {
                titulo.innerText = "Saídas Detalhadas"; titulo.style.color = "var(--danger)";
                db.contas.filter(c => c.mesRef === mesSelecionado).forEach(c => itens.push({n: c.nome, v: c.valor}));
                db.gastos.filter(g => g.mesRef === mesSelecionado).forEach(g => itens.push({n: g.nome, v: g.valor}));
            }

            if(itens.length === 0) {
                lista.innerHTML = "<li style='text-align:center; padding:10px;'>Sem registros.</li>";
            } else {
                itens.sort((a,b) => b.v - a.v);
                itens.forEach(i => {
                    lista.innerHTML += `<li class="relatorio-item"><span>${i.n}</span><span>${i.v.toLocaleString('pt-BR', fmt)}</span></li>`;
                });
            }
            abrirModalId('modal-lista');
        }

        function abrirRelatorioDRE() {
            fecharModalId('modal-func');
            const el = document.getElementById('conteudo-dre');
            const extras = db.extras.filter(x => x.mesRef === mesSelecionado).reduce((a,b)=>a+b.valor,0);
            
            // Soma histórico emprestimos
            let empRec = 0;
            db.emprestimos.forEach(e => { empRec += (e.valor * e.pagas); });

            const contas = db.contas.filter(c => c.mesRef === mesSelecionado).reduce((a,b)=>a+b.valor,0);
            const gastos = db.gastos.filter(g => g.mesRef === mesSelecionado).reduce((a,b)=>a+b.valor,0);
            
            const totalRec = extras + empRec;
            const totalDesp = contas + gastos;
            const lucro = totalRec - totalDesp;

            el.innerHTML = `
                <p style="display:flex; justify-content:space-between; font-weight:bold;"><span>(+) Receita Bruta</span> <span>R$ ${totalRec.toFixed(2)}</span></p>
                <hr style="margin:10px 0; border-color:var(--border);">
                <p style="display:flex; justify-content:space-between;"><span>(-) Contas Fixas</span> <span style="color:var(--danger)">R$ ${contas.toFixed(2)}</span></p>
                <p style="display:flex; justify-content:space-between;"><span>(-) Gastos Variáveis</span> <span style="color:var(--danger)">R$ ${gastos.toFixed(2)}</span></p>
                <hr style="margin:10px 0; border-color:var(--border);">
                <p style="font-size:18px; display:flex; justify-content:space-between;"><strong>(=) Resultado</strong> <span style="color:${lucro>=0?'var(--success)':'var(--danger)'}">R$ ${lucro.toFixed(2)}</span></p>
            `;
            abrirModalId('modal-dre');
        }

        // --- BACKUP/RESTORE/THEME/IMPORT ---
        function baixarBackup() { /* ... */ const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup_financas.json"); document.body.appendChild(dl); dl.click(); dl.remove(); }
        function restaurarBackup(input) { /* ... */ const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { db = JSON.parse(e.target.result); saveDB(); showToast("Restaurado!"); location.reload(); } catch(err) { showToast("Erro no arquivo"); } }; reader.readAsText(file); }
        function toggleDarkMode() { /* ... */ const current = document.documentElement.getAttribute('data-theme'); const target = current === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', target); localStorage.setItem('financas_tema', target); const icon = document.getElementById('icon-theme'); if(target === 'dark') { icon.classList.replace('fa-moon', 'fa-sun'); } else { icon.classList.replace('fa-sun', 'fa-moon'); } }
        function verificarBotaoImportar() { const btn = document.getElementById('btn-importar'); const contasMes = db.contas.filter(c => c.mesRef === mesSelecionado); btn.style.display = (contasMes.length === 0 && mesSelecionado !== `${anoFixo}-01`) ? 'flex' : 'none'; }
        function importarContasMesAnterior() { let partes = mesSelecionado.split('-'); let mesAnt = parseInt(partes[1]) - 1; let chaveAnt = `${anoFixo}-${String(mesAnt).padStart(2, '0')}`; const contasAnt = db.contas.filter(c => c.mesRef === chaveAnt); if (contasAnt.length === 0) { showToast("Sem dados anteriores."); return; } contasAnt.forEach(c => { db.contas.push({ id: Date.now() + Math.random(), nome: c.nome, valor: c.valor, pago: false, mesRef: mesSelecionado, vencimento: "" }); }); saveDB(); renderContas(); verificarBotaoImportar(); }
        
        // --- CÁLCULADORA ---
        function addCalc(v) { const d = document.getElementById('calc-display'); if(d.innerText === '0' && !['/','*','-','+'].includes(v)) d.innerText = v; else d.innerText += v; }
        function clearCalc() { document.getElementById('calc-display').innerText = '0'; }
        function resultCalc() { try { document.getElementById('calc-display').innerText = eval(document.getElementById('calc-display').innerText); } catch { document.getElementById('calc-display').innerText = 'Erro'; } }

        // --- OUTROS ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        async function tentarInstallAndroid() { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; } else { document.getElementById('android-help').style.display = 'block'; } }
        function mostrarHelpIOS() { document.getElementById('ios-help').style.display = 'block'; }
        
        // CLICK FORA PARA FECHAR DROPDOWN E MODAL
        window.onclick = function(e) { 
            if(!e.target.matches('.btn-more') && !e.target.matches('.fa-ellipsis-vertical')) {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
            }
            if(e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        }

        init();
    </script>
</body>
</html>